<div class="expense-list-container">
  <div class="header">
    <h2>Liste des d√©penses</h2>
    @if (!showForm()) {
      <button class="btn-add" (click)="onAddExpense()">+ Ajouter une d√©pense</button>
    }
  </div>

  @if (showForm()) {
    <app-expense-form
      (saved)="onFormSaved()"
      (cancelled)="onFormCancelled()"
    />
  }

  @if (loading()) {
    <div class="loading">Chargement...</div>
  }

  @if (error() && !showForm()) {
    <div class="error">{{ error() }}</div>
  }

  @if (!loading() && !error() && !showForm()) {
    @if ((expensesResult() ?? []).length === 0) {
      <div class="empty">Aucune d√©pense trouv√©e</div>
    } @else {
      <div class="filters-section">
        <h3>Filtres</h3>
        <div class="filters">
          <div class="filter-group">
            <label for="year-filter">Ann√©e :</label>
            <select 
              id="year-filter"
              [value]="selectedYear() ?? ''"
              (change)="selectedYear.set($any($event.target).value ? +$any($event.target).value : null); onFilterChange()"
            >
              <option value="">Toutes</option>
              @for (year of availableYears(); track year) {
                <option [value]="year">{{ year }}</option>
              }
            </select>
          </div>

          <div class="filter-group">
            <label for="month-filter">Mois :</label>
            <select 
              id="month-filter"
              [value]="selectedMonth() ?? ''"
              (change)="selectedMonth.set($any($event.target).value ? +$any($event.target).value : null); onFilterChange()"
            >
              <option value="">Tous</option>
              @for (month of availableMonths(); track month) {
                <option [value]="month">{{ monthNames[month - 1] }}</option>
              }
            </select>
          </div>

          <div class="filter-group">
            <label for="user-filter">Utilisateur :</label>
            <select 
              id="user-filter"
              [value]="selectedUserId() ?? ''"
              (change)="selectedUserId.set($any($event.target).value || null); onFilterChange()"
            >
              <option value="">Tous</option>
              @for (user of availableUsers(); track user.id) {
                <option [value]="user.id">{{ user.name }}</option>
              }
            </select>
          </div>

          <button class="btn-clear-filters" (click)="clearFilters()">Effacer les filtres</button>
        </div>
      </div>

      @if (expenses().length === 0) {
        <div class="empty">Aucune d√©pense ne correspond aux filtres s√©lectionn√©s</div>
      } @else {
        <div class="expenses-summary">
          <div class="summary-item">
            <span class="summary-label">Nombre de d√©penses :</span>
            <span class="summary-value">{{ expenses().length }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total :</span>
            <span class="summary-value total">{{ formatAmount(totalAmount()) }}</span>
          </div>
        </div>

        <table class="expense-table">
        <thead>
          <tr>
            <th>
              <button class="sortable-header" (click)="onSort('user')" [class.sorted]="isSorted('user')">
                Utilisateur
                <span class="sort-icon">{{ getSortIcon('user') }}</span>
              </button>
            </th>
            <th>Description</th>
            <th>
              <button class="sortable-header" (click)="onSort('amount')" [class.sorted]="isSorted('amount')">
                Montant
                <span class="sort-icon">{{ getSortIcon('amount') }}</span>
              </button>
            </th>
            <th>
              <button class="sortable-header" (click)="onSort('date')" [class.sorted]="isSorted('date')">
                Date
                <span class="sort-icon">{{ getSortIcon('date') }}</span>
              </button>
            </th>
            <th>Cat√©gorie</th>
            <th>Adresse de facturation</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (expense of expenses(); track expense.id) {
            <tr>
              <td>
                <a [routerLink]="['/users', expense.userId]" class="user-link">
                  {{ expense.userName }}
                </a>
              </td>
              <td>{{ expense.description }}</td>
              <td class="amount">{{ formatAmount(expense.amount) }}</td>
              <td>{{ formatDate(expense.date) }}</td>
              <td>
                @if (expense.category) {
                  <span class="category-badge">{{ expense.category }}</span>
                } @else {
                  <span class="no-category">-</span>
                }
              </td>
              <td>
                @if (expense.billingCompany || expense.billingStreet) {
                  <div class="billing-address">
                    @if (expense.billingCompany) {
                      <div class="billing-company">{{ expense.billingCompany }}</div>
                    }
                    @if (expense.billingStreet) {
                      <div class="billing-street">{{ expense.billingStreet }}</div>
                    }
                    @if (expense.billingPostalCode || expense.billingCity) {
                      <div class="billing-city">
                        @if (expense.billingPostalCode) {
                          <span>{{ expense.billingPostalCode }}</span>
                        }
                        @if (expense.billingCity) {
                          <span>{{ expense.billingCity }}</span>
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <span class="no-address">-</span>
                }
              </td>
              <td>
                <button class="btn-delete" (click)="onDeleteExpense(expense.id, expense.description)" title="Supprimer">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      }
    }
  }
</div>

